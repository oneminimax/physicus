\NeedsTeXFormat{LaTeX2e}
\ProvidesPackage{physicus}

\usepackage{esdiff}
\usepackage{mathtools}

% Linear algebra

\DeclareMathOperator{\trace}{Tr}%
\newcommand{\pmqty}[1]{
  \begin{pmatrix}#1
\end{pmatrix}}%
\newcommand{\vb}[1]{\ensuremath{\mathbf{#1}}}%
\newcommand{\vu}[1]{\ensuremath{\hat{\mathbf{#1}}}}%
\newcommand{\vd}[1]{\ensuremath{\mathrm{#1}}}%

\AtBeginDocument{%
  \renewcommand\Re{\operatorname{Re}}%
  \renewcommand\Im{\operatorname{Im}}%
}

\DeclarePairedDelimiterX\innerp[2]{\langle}{\rangle}{#1,#2}%

% Quantum and dirac notation

\DeclarePairedDelimiter{\pqty}{\lparen}{\rparen}%
\DeclarePairedDelimiter{\bqty}{\lbrack}{\rbrack}%
\DeclarePairedDelimiter{\Bqty}{\lbrace}{\rbrace}%

\DeclarePairedDelimiterX\abs[1]{\lvert}{\rvert}{#1}%
\DeclarePairedDelimiterX\norm[1]{\lVert}{\rVert}{#1}%
\DeclarePairedDelimiterX\eval[1]{.}{\rvert}{#1}%
\DeclarePairedDelimiterXPP\order[1]{\mathcal{O}}{\lparen}{\rparen}{}{#1}%

\DeclarePairedDelimiter{\bra}{\langle}{\rvert}%
\DeclarePairedDelimiter{\ket}{\lvert}{\rangle}%

\DeclarePairedDelimiterX\braket[2]{\langle}{\rangle}{#1\delimsize\vert\mathopen{}#2}%
\DeclarePairedDelimiterX\mel[3]{\langle}{\rangle}{#1\delimsize\vert\mathopen{}#2\delimsize\vert\mathopen{}#3}%
\DeclarePairedDelimiterX\expval[2]{\langle}{\rangle}{#2\delimsize\vert\mathopen{}#1\delimsize\vert\mathopen{}#2}%
\DeclarePairedDelimiterX\expsval[1]{\langle}{\rangle}{#1}%
\DeclarePairedDelimiterX\ketbra[2]{\lvert}{\rvert}{#1\delimsize\rangle\!\delimsize\langle#2}%
\DeclarePairedDelimiterX\outerp[2]{\lvert}{\rvert}{#1\delimsize\rangle\!\delimsize\langle#2}%
\DeclarePairedDelimiterX\projector[1]{\lvert}{\rvert}{#1\delimsize\rangle\!\delimsize\langle#1}%

\DeclarePairedDelimiterX\commutator[2]{\lbrack}{\rbrack}{#1,#2}%
\DeclarePairedDelimiterX\anticommutator[2]{\lbrace}{\rbrace}{#1,#2}%

% Derivatives
% Code inspired by esdiff

\let\grad\nabla%
\newcommand{\dd}{\mathrm{d}}%
% \newcommand{\grad}{\nabla}%

\let\bbrack=[ %
\let\ebrack=] %

% \DeclareRobustCommand{\ppdv}[1]{%
% \@ifnextchar\bgroup{\@ppdv{#1}}{\@ppdv{}{#1}}}
% \newcommand{\@ppdv}[2]{\frac{\partial#1}{\partial#2}}

% \def\@ppdv{\@ifnextchar\bbrack{\pdv@a}{\pdv@b}}
% \def\pdv@a[#1]#2#3{\mathchoice
%   {\frac{\partial^{#1} #2}{\partial #3^{#1}}}%
%   {\frac{\partial^{#1} #2}{\partial #3^{#1}}}%
%   {\scriptstyle{\frac{\partial^{#1}#2}{\partial #3^{#1}}}}%
%   {\scriptstyle{\frac{\partial^{#1}#2}{\partial #3^{#1}}}}%
% }
% \def\pdv@b#1#2{\mathchoice
%   {\frac{\partial #1}{\partial #2}}%
%   {{\frac{\partial #1}{\partial #2}}}%
%   {\scriptstyle{\frac{\partial #1}{\partial #2}}}%
%   {\scriptstyle{\frac{\partial #1}{\partial #2}}}
% }

\def\dv{\@ifnextchar\bbrack{\dv@a}{\dv@b}}
\def\dv@a[#1]#2#3{\mathchoice
  {\frac{\dd^{#1} #2}{\dd #3^{#1}}}%
  {\frac{\dd^{#1} #2}{\dd #3^{#1}}}%
  {\scriptstyle{\frac{\dd^{#1}#2}{\dd #3^{#1}}}}%
  {\scriptstyle{\frac{\dd^{#1}#2}{\dd #3^{#1}}}}%
}
\def\dv@b#1#2{\mathchoice
  {\frac{\dd #1}{\dd #2}}%
  {{\frac{\dd #1}{\dd #2}}}%
  {\scriptstyle{\frac{\dd #1}{\dd #2}}}%
  {\scriptstyle{\frac{\dd #1}{\dd #2}}}
}

\def\pdv{\@ifnextchar\bbrack{\pdv@a}{\pdv@b}}
\def\pdv@a[#1]#2#3{\mathchoice
  {\frac{\partial^{#1} #2}{\partial #3^{#1}}}%
  {\frac{\partial^{#1} #2}{\partial #3^{#1}}}%
  {\scriptstyle{\frac{\partial^{#1}#2}{\partial #3^{#1}}}}%
  {\scriptstyle{\frac{\partial^{#1}#2}{\partial #3^{#1}}}}%
}
\def\pdv@b#1#2{\mathchoice
  {\frac{\partial #1}{\partial #2}}%
  {{\frac{\partial #1}{\partial #2}}}%
  {\scriptstyle{\frac{\partial #1}{\partial #2}}}%
  {\scriptstyle{\frac{\partial #1}{\partial #2}}}
}
